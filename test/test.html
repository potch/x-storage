<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <title>x-storage test</title>
    <script src="../bower_components/platform/platform.js"></script>
    <link rel="stylesheet" media="all" href="../bower_components/mocha/mocha.css">
    <script src="../bower_components/mocha/mocha.js"></script>
    <script src="../bower_components/chai/chai.js"></script>
    <script src="../index.js"></script>
  </head>
  <body>
    <h1>x-storage test</h1>
    <div id="mocha"><p><a href=".">Index</a></p></div>
    <div id="messages"></div>
    <div id="fixtures"></div>
    <key-value id="store" name="bar"></key-value>
    <script>
      if (window.mochaPhantomJS) { mochaPhantomJS.run(); }
      else { mocha.run(); }
    </script>
    <script>
      mocha.setup('bdd');
      var kv = document.querySelector('#store');

      var expect = chai.expect;
      
      var timeout = 5000;
      var n = 200;
      var k = 10;

      function randomString() {
        return Math.random().toString(36).substr(2);
      }

      function randomNumber() {
        return Math.round(Math.random()*1000000);
      }

      function randomContent() {
        return Math.random() < 0.5 ? randomString() : randomNumber();
      }

      function generateSampleItems(n) {
        var collection = {};
        var items = [];
        while(Object.keys(collection).length < n) {
          key = randomContent();
          collection[key] = randomContent();
        }
        for (var itemKey in collection) {
          var item = {};
          item.key = itemKey;
          item.value = collection[itemKey];
          items.push(item);
        }
        return items;
      }

      function sortArray(array, property){
        var arr = array.slice(0);
        return arr.sort(function(a,b){
          var a1=typeof a[property], b1=typeof b[property];
          return a1<b1 ? -1 : a1>b1 ? 1 : a[property]<b[property] ? -1 : a[property]>b[property] ? 1 : 0;
        });
      }

      function populateDb(){
        var array = sampleItems.slice(0);
        return kv.clear()
          .then(function() {
            return array.reduce(function (prev, cur, i) {
              return prev.then(function() {
                return kv.set(cur.key, cur.value) 
              });
            }, Promise.resolve());
          });
      }

      // function populateDb(){
      //   return kv.clear()
      //     .then(function() {
      //       return new Promise(function(resolve,reject){
      //         (function sequentialInsert(array, index) {
      //           var item = array[index];
      //           kv.set(item.key, item.value)
      //             .then(function(){
      //               index++;
      //               if (index < array.length){
      //                 sequentialInsert(array,index);
      //               } else {
      //                 resolve()
      //               }
      //             });
      //         })(sampleItems,0);
      //       });
      //     });
      // }

      describe("the key value store", function(){
        this.timeout(timeout);

        before(function(done){
          sampleItems = generateSampleItems(n);
          populateDb()
            .then(function(){
              done();
            })
        })

        it("should return size() == " + n, function(done){
          kv.size()
            .then(function(s){expect(s).to.equal(sampleItems.length); done();})
        });



        it("should getAll({'orderBy':'insertionTime'}) all items orderedBy insertionTime", function(done){
          var arr = sampleItems.slice(0);
          kv.getAll({'orderBy':'insertionTime'})
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i].key).to.equal(arr[i].key);
                expect(all[i].value).to.equal(arr[i].value);
              };
              done(); 
            })
        });
        it("should getAll({'orderBy':'insertionTime', 'reverse': true}) all items orderedBy insertionTime reversed", function(done){
          var arr = sampleItems.slice(0);
          kv.getAll({'orderBy':'insertionTime', 'reverse': true})
            .then(function(all){
              arr.reverse();
              for (var i = 0; i < all.length; i++) {
                expect(all[i].key).to.equal(arr[i].key);
                expect(all[i].value).to.equal(arr[i].value);
              };
              done(); 
            })
        });
        it("should getAll({'orderBy':'value') all items orderedBy value", function(done){
          var arr = sortArray(sampleItems,"value");
          kv.getAll({'orderBy':'value'})
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i].key).to.equal(arr[i].key);
                expect(all[i].value).to.equal(arr[i].value);
              }
              done();              
            });
        });
        it("should getAll({'orderBy':'value', 'reverse': true}) all items orderedBy value reversed", function(done){
          var arr = sortArray(sampleItems,"value");
          arr.reverse();
          kv.getAll({'orderBy':'value', 'reverse':true})
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i].key).to.equal(arr[i].key);
                expect(all[i].value).to.equal(arr[i].value);
              }
              done();              
            });
        });
        it("should getAll() all items orderedBy key", function(done){
          var arr = sortArray(sampleItems,"key");
          kv.getAll()
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i].key).to.equal(arr[i].key);
                expect(all[i].value).to.equal(arr[i].value);
              }
              done();              
            });
        });
        it("should getAll() all items orderedBy key, reversed", function(done){
          var arr = sortArray(sampleItems,"key");
          arr.reverse();
          kv.getAll({'reverse': true})
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i].key).to.equal(arr[i].key);
                expect(all[i].value).to.equal(arr[i].value);
              }
              done();              
            });
        });
        it("should getRange({count: 5}) 5 items orderedBy key", function(done){
          var arr = sortArray(sampleItems,"key");
          kv.getRange({'count':5})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i].key).to.equal(arr[i].key);
                expect(all[i].value).to.equal(arr[i].value);
              }
              done();              
            });
        });
        it("should getRange({count: 5, start: key}) 5 items orderedBy key starting with key", function(done){
          var arr = sortArray(sampleItems,"key");
          var startkey = arr[3].key;
          kv.getRange({'count':5,'start':startkey})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i].key).to.equal(arr[i+3].key);
                expect(all[i].value).to.equal(arr[i+3].value);
              }
              done();              
            });
        });
        it("should return size() == " + n + " after updating " + k + " items", function(done){
          var promises = [];
          for (var i = 0; i < k; i++) {
            var key = sampleItems[i].key;
            promises.push(kv.set(key,randomContent()));
          };
          Promise.all(promises)
            .then(function(){return kv.size();})
            .then(function(s){expect(s).to.equal(n); done();});
        });
        it("should set(k,v) and get(k) an item", function(done){
          kv.set("theKey","theValue")
            .then(function(){ return kv.get("theKey") })
            .then(function(i){ expect(i).to.equal("theValue"); done();});
        });
        it("should set(k,v) and get(k) an existing item", function(done){
          kv.set("theKey","theValue2")
            .then(function(){ return kv.get("theKey") })
            .then(function(i){ expect(i).to.equal("theValue2"); done();});
        });
        it("should be empty again after clear()", function(done){
          kv.clear()
            .then(function(){return kv.size();})
            .then(function(s){expect(s).to.equal(0); done();})
        });
      })

      // document.addEventListener('DOMContentLoaded', function(){
      //   kv.clear().then(function(){
      //     mocha.run();
      //   });
      // }, false);        
    </script>
    <script>
      if (window.mochaPhantomJS) { mochaPhantomJS.run(); }
      else { mocha.run(); }
    </script>
  </body>
</html>
